<!DOCTYPE html>
<html>
<head>
  <title>Chat Room</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial; padding:20px }
    #chat { border:1px solid #ccc; height:300px; overflow:auto; padding:10px }
    input, button, select { width:100%; padding:10px; margin-top:10px }
    #roomTitle { margin-top:20px }
    .msg-user { font-weight:bold }
    .msg { margin-bottom:5px }
    .file { color:#007bff; text-decoration:underline; cursor:pointer }
    #audioRing { display:none; }
  </style>
</head>
<body>
<select id="roomSelect"></select>
<button onclick="joinRoom()">Join Room</button>
<button onclick="startAudioCall()">Audio Call</button>
<button onclick="uploadFile()">Upload File/Image</button>
<button onclick="capturePhoto()">Take Photo</button>
<h3 id="roomTitle">Chat Room</h3>
<div id="chat"></div>
<input id="msg" placeholder="Message">
<button onclick="send()">Send</button>
<input type="file" id="fileInput" style="display:none" accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
<canvas id="photoCanvas" style="display:none"></canvas>
<audio id="audioRing" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<script>
var firebaseConfig = {
  apiKey: "AIzaSyBpcY72lQEziKJBdMWCgOIxWKLwIWe1Fgw",
  databaseURL: "https://royrohit-294fc-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "royrohit-294fc"
};
firebase.initializeApp(firebaseConfig);

let user = localStorage.getItem("user");
let pass = localStorage.getItem("pass");
if (!user || !pass) window.location.href = "index.html";
firebase.database().ref("users/"+user).once("value", snap => {
  var d = snap.val();
  if (!d || d.password !== pass || d.blocked || !d.approved) window.location.href = "index.html";
});

let room = "general";
let chatBox = document.getElementById("chat");
let audioRing = document.getElementById("audioRing");

// Room list
firebase.database().ref("rooms").on("value", snap => {
  let sel = document.getElementById("roomSelect");
  sel.innerHTML = "";
  snap.forEach(c => {
    let opt = document.createElement("option");
    opt.value = c.key;
    opt.innerText = c.key;
    sel.appendChild(opt);
  });
  sel.value = room;
});
document.getElementById("roomSelect").onchange = function() {
  joinRoom();
};

function joinRoom() {
  room = document.getElementById("roomSelect").value;
  document.getElementById("roomTitle").innerText = "Room: " + room;
  loadChat();
}
function loadChat() {
  chatBox.innerHTML = "";
  firebase.database().ref("chats/"+room).off();
  firebase.database().ref("chats/"+room).on("child_added", s => {
    let v = s.val();
    let html = `<div class="msg"><span class="msg-user">${v.name || "Anon"}:</span> `;
    if (v.msg) html += v.msg;
    if (v.file) html += `<a class="file" href="${v.file}" target="_blank">[File]</a>`;
    if (v.photo) html += `<br><img src="${v.photo}" style="max-width:120px">`;
    html += "</div>";
    chatBox.innerHTML += html;
    chatBox.scrollTop = chatBox.scrollHeight;
    // Popup/ringtone for incoming call
    if (v.call && v.name !== user) {
      popupCall(v.name);
    }
  });
}
function send() {
  var text = document.getElementById("msg").value;
  if (!text.trim()) return;
  firebase.database().ref("chats/"+room).push({ msg:text, name: user });
  document.getElementById("msg").value = "";
}
function uploadFile() {
  document.getElementById("fileInput").click();
}
document.getElementById("fileInput").onchange = function(e) {
  let file = e.target.files[0];
  if (!file) return;
  let ref = firebase.storage().ref("uploads/"+room+"/"+Date.now()+"_"+file.name);
  ref.put(file).then(snap => {
    ref.getDownloadURL().then(url => {
      firebase.database().ref("chats/"+room).push({ file:url, name:user });
    });
  });
};
function capturePhoto() {
  navigator.mediaDevices.getUserMedia({ video:true }).then(stream => {
    let video = document.createElement("video");
    video.srcObject = stream;
    video.play();
    video.onloadedmetadata = () => {
      let canvas = document.getElementById("photoCanvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      let ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0);
      stream.getTracks().forEach(track => track.stop());
      canvas.toBlob(blob => {
        let ref = firebase.storage().ref("uploads/"+room+"/photo_"+Date.now()+".png");
        ref.put(blob).then(snap => {
          ref.getDownloadURL().then(url => {
            firebase.database().ref("chats/"+room).push({ photo:url, name:user });
          });
        });
      }, "image/png");
    };
  });
}
function startAudioCall() {
  // Notify all users in room
  firebase.database().ref("chats/"+room).push({ call:true, name:user });
  window.open("call.html?room="+encodeURIComponent(room), "_blank");
}
function popupCall(caller) {
  audioRing.play();
  alert("Incoming audio call from " + caller + "!\nClick OK to join.");
  window.open("call.html?room="+encodeURIComponent(room), "_blank");
}

// Create room if not exists
firebase.database().ref("rooms/"+room).set(true);
loadChat();
</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>Chat Room</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; background: #f4f4f4; }
    body { display: flex; flex-direction: column; height: 100vh; min-height: 100vh; }
    #topbar {
      background: #fff;
      padding: 6px 4px 4px 4px;
      box-shadow: 0 2px 8px #eee;
      z-index: 10;
      position: sticky;
      top: 0;
      width: 100%;
      border-radius: 0 0 12px 12px;
      margin-bottom: 2px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .topbar-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      justify-content: center;
      margin-bottom: 2px;
    }
    #roomTitle { font-size: 16px; font-weight: bold; min-width: 80px; margin-right: 4px; }
    #roomSelect, #newRoom, #userSelect {
      padding: 6px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
      min-width: 70px;
      max-width: 110px;
    }
    .topbar-row button {
      padding: 6px 10px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      background: #007bff;
      color: #fff;
      min-width: 60px;
      cursor: pointer;
      flex: 0 0 auto;
    }
    .logout-btn { background: #dc3545; color: #fff; }
    #chat {
      flex: 1 1 auto;
      overflow-y: auto;
      margin: 0 auto;
      max-width: 600px;
      width: 100%;
      padding: 4px 0 80px 0;
      box-sizing: border-box;
    }
    .msg-user { font-weight: bold }
    .msg {
      margin-bottom: 8px;
      background: #fff;
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 1px 2px #ccc;
      word-break: break-word;
      white-space: pre-line;
    }
    .file { color: #007bff; text-decoration: underline; cursor: pointer }
    #audioRing { display: none; }
    #msgBar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #fff;
      padding: 8px 4px;
      box-shadow: 0 -2px 8px #ccc;
      display: flex;
      gap: 6px;
      align-items: flex-end;
      z-index: 20;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    #msgBar textarea {
      flex: 1 1 auto;
      padding: 8px;
      resize: vertical;
      min-height: 36px;
      max-height: 100px;
      font-size: 15px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    #msgBar button, #msgBar input[type=file] {
      padding: 8px 12px;
      font-size: 15px;
      border: none;
      border-radius: 4px;
      background: #007bff;
      color: #fff;
      cursor: pointer;
      flex: 0 0 auto;
    }
    @media (max-width: 600px) {
      #topbar { padding: 3px; max-width: 100vw; border-radius: 0 0 8px 8px; }
      .topbar-row { flex-direction: row; flex-wrap: wrap; gap: 4px; margin-bottom: 2px; }
      #roomTitle { font-size: 14px; }
      .topbar-row button { font-size: 13px; min-width: 48px; padding: 5px 6px; }
      #roomSelect, #newRoom, #userSelect { font-size: 13px; min-width: 60px; max-width: 90px; padding: 5px; }
      #msgBar { flex-direction: column; gap: 4px; padding: 6px 2px; max-width: 100vw; }
      #msgBar textarea { width: 100%; }
    }
  </style>
</head>
<body>
<div id="topbar">
  <div class="topbar-row">
    <span id="roomTitle">Room: general</span>
    <select id="roomSelect"></select>
    <button onclick="joinRoom()">Join</button>
    <input id="newRoom" type="text" placeholder="New room">
    <button onclick="createRoom()">Create</button>
  </div>
  <div class="topbar-row">
    <select id="userSelect"></select>
    <button onclick="callUser()">Call User</button>
    <button onclick="uploadFile()">Upload</button>
    <button onclick="capturePhoto()">Photo</button>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</div>
<div id="chat"></div>
<div id="msgBar">
  <textarea id="msg" placeholder="Type your message..."></textarea>
  <button onclick="send()">Send</button>
  <input type="file" id="fileInput" style="display:none" accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
</div>
<canvas id="photoCanvas" style="display:none"></canvas>
<audio id="audioRing" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto" loop></audio>

<!-- Incoming Call Modal -->
<div id="callModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
  <div id="callModalContent" style="background:#fff; padding:30px; border-radius:10px; text-align:center; box-shadow:0 2px 12px #222;">
    <h2>Incoming Audio Call</h2>
    <p id="callFrom"></p>
    <button onclick="acceptCall()">Accept</button>
    <button onclick="declineCall()">Decline</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
<script>
var firebaseConfig = {
  apiKey: "AIzaSyBpcY72lQEziKJBdMWCgOIxWKLwIWe1Fgw",
  databaseURL: "https://royrohit-294fc-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "royrohit-294fc",
  storageBucket: "royrohit-294fc.appspot.com"
};
firebase.initializeApp(firebaseConfig);

// Persistent login
let user = localStorage.getItem("user");
let pass = localStorage.getItem("pass");
if (!user || !pass) window.location.href = "index.html";
firebase.database().ref("users/"+user).once("value", snap => {
  var d = snap.val();
  if (!d || d.password !== pass || d.blocked) {
    localStorage.clear();
    window.location.href = "index.html";
  }
});

let room = "general";
let chatBox = document.getElementById("chat");
let audioRing = document.getElementById("audioRing");
let lastCallId = null; // Track last call event
let incomingCallRoom = null;
let incomingCallFrom = null;
let incomingCallJitsiRoom = null;

// Room list
function loadRooms() {
  firebase.database().ref("rooms").on("value", snap => {
    let sel = document.getElementById("roomSelect");
    sel.innerHTML = "";
    snap.forEach(c => {
      let opt = document.createElement("option");
      opt.value = c.key;
      opt.innerText = c.key;
      sel.appendChild(opt);
    });
    sel.value = room;
    document.getElementById("roomTitle").innerText = "Room: " + room;
  });
}
loadRooms();

// User list for one-to-one call
function loadUsers() {
  firebase.database().ref("users").on("value", snap => {
    let sel = document.getElementById("userSelect");
    sel.innerHTML = "";
    snap.forEach(c => {
      if (c.key !== user) {
        let opt = document.createElement("option");
        opt.value = c.key;
        opt.innerText = c.key;
        sel.appendChild(opt);
      }
    });
  });
}
loadUsers();

document.getElementById("roomSelect").onchange = function() {
  joinRoom();
};

function joinRoom() {
  room = document.getElementById("roomSelect").value;
  document.getElementById("roomTitle").innerText = "Room: " + room;
  loadChat();
}
function createRoom() {
  let r = document.getElementById("newRoom").value.trim();
  if (!r) return alert("Enter room name");
  firebase.database().ref("rooms/"+r).set(true, () => {
    document.getElementById("newRoom").value = "";
    room = r;
    loadRooms();
    loadChat();
  });
}
function loadChat() {
  chatBox.innerHTML = "";
  firebase.database().ref("chats/"+room).off();
  firebase.database().ref("chats/"+room).on("child_added", s => {
    let v = s.val();
    let html = `<div class="msg"><span class="msg-user">${v.name || "Anon"}:</span> `;
    if (v.msg) html += v.msg.replace(/\n/g, "<br>");
    if (v.file) html += `<a class="file" href="${v.file}" target="_blank">[File]</a>`;
    if (v.photo) html += `<br><img src="${v.photo}" style="max-width:120px">`;
    html += "</div>";
    chatBox.innerHTML += html;
    chatBox.scrollTop = chatBox.scrollHeight;

    // One-to-one call popup
    if (v.one2oneCall && v.to === user && s.key !== lastCallId) {
      lastCallId = s.key;
      popupCall(v.from, v.jitsiRoom);
    }
  });
}
function send() {
  var text = document.getElementById("msg").value;
  if (!text.trim()) return;
  firebase.database().ref("chats/"+room).push({ msg:text, name: user });
  document.getElementById("msg").value = "";
}

function uploadFile() {
  document.getElementById("fileInput").value = ""; // reset so same file can be uploaded again
  document.getElementById("fileInput").click();
}
document.getElementById("fileInput").onchange = function(e) {
  let file = e.target.files[0];
  if (!file) return;
  let ref = firebase.storage().ref("uploads/"+room+"/"+Date.now()+"_"+file.name);
  ref.put(file).then(snap => {
    ref.ref.getDownloadURL().then(url => {
      firebase.database().ref("chats/"+room).push({ file:url, name:user });
    });
  }).catch(err => alert("Upload failed: " + err.message));
};
function capturePhoto() {
  navigator.mediaDevices.getUserMedia({ video:true }).then(stream => {
    let video = document.createElement("video");
    video.srcObject = stream;
    video.play();
    video.onloadedmetadata = () => {
      let canvas = document.getElementById("photoCanvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      let ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0);
      stream.getTracks().forEach(track => track.stop());
      canvas.toBlob(blob => {
        let ref = firebase.storage().ref("uploads/"+room+"/photo_"+Date.now()+".png");
        ref.put(blob).then(snap => {
          ref.ref.getDownloadURL().then(url => {
            firebase.database().ref("chats/"+room).push({ photo:url, name:user });
          });
        });
      }, "image/png");
    };
  }).catch(err => alert("Camera error: " + err.message));
}

// One-to-one call
function callUser() {
  let toUser = document.getElementById("userSelect").value;
  if (!toUser) return alert("Select a user to call.");
  // Generate a unique Jitsi room name for every call
  let jitsiRoom = "OpenChat_" + user + "_to_" + toUser + "_" + Date.now();
  firebase.database().ref("chats/"+room).push({
    one2oneCall: true,
    from: user,
    to: toUser,
    jitsiRoom: jitsiRoom
  });
  window.open("call.html?room="+encodeURIComponent(jitsiRoom), "_blank");
}

function popupCall(from, jitsiRoom) {
  audioRing.currentTime = 0;
  audioRing.play();
  document.getElementById("callFrom").innerText = "From: " + from;
  document.getElementById("callModal").style.display = "flex";
  incomingCallJitsiRoom = jitsiRoom;
}
function acceptCall() {
  audioRing.pause();
  audioRing.currentTime = 0;
  document.getElementById("callModal").style.display = "none";
  window.open("call.html?room="+encodeURIComponent(incomingCallJitsiRoom), "_blank");
}
function declineCall() {
  audioRing.pause();
  audioRing.currentTime = 0;
  document.getElementById("callModal").style.display = "none";
}
function logout() {
  localStorage.clear();
  window.location.href = "index.html";
}

// Create room if not exists
firebase.database().ref("rooms/"+room).set(true);
loadChat();
</script>
</body>
</html>
